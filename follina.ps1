
# Script to check for the existence of the MSDT Protocol URL registry key and disable it
# Official Microsoft guidance here: https://msrc-blog.microsoft.com/2022/05/30/guidance-for-cve-2022-30190-microsoft-support-diagnostic-tool-vulnerability/
# It backs up the MSDT registry key and deletes the key
# additional feature to import the key back for future usecase and testing purposes
# By :- Ekam Singh Waia


try { 
         
    Write-Host "Checking the system to see if the MSDT URL Protocol is still enabled" -ForegroundColor Yellow
    New-PSDrive -Name HKCR -PSProvider Registry -Root HKEY_CLASSES_ROOT 
    $regkeypath = 'HKCR:\ms-msdt'
    $checkkey = (Get-ItemProperty $regkeypath)
         
    if ($checkkey -ne $null) { 
        try { 
             
            Write-Warning "Your machine is vulnerable to the Follina vunerability CVE-2022-30190. Would you like to disable MSDT URL Protocol and backup the registry key?" -WarningAction Inquire 
            $baclocation = Read-Host -Prompt "Enter your file path where you want to backup the registry key. If you don't enter anything, it will default to backing up to your desktop"
            if ([string]::IsNullOrWhiteSpace($baclocation))
            {
                $baclocation = "$($env:UserProfile)\Desktop\msdturlprotocol.reg"
            }
            reg export HKEY_CLASSES_ROOT\ms-msdt $baclocation
            reg delete HKEY_CLASSES_ROOT\ms-msdt /f
            Write-Host "The MSDT URL Protocol registry key has been backed up and has now been disabled" -ForegroundColor Green 
            } 
        catch { 
                Write-Host "You chose not to implement the MSDT URL Protocol workaround" -ForegroundColor Red 
            }    
    }     
    else {
        Write-Host "Your workstation already has the MSDT URL Protocol workaround" -ForegroundColor Green
        
        Write-Host "Do you want to import the registry key?" -ForegroundColor Red
        Write-Host "------------------------------";
        $ImportLocation = Read-Host -Prompt "Enter your file path'Where you have the copy of the registry? If you don't enter anything, it will search for the key in the Desktop "
        if ([string]::IsNullOrWhiteSpace($ImportLocation))
        {
            $ImportLocation = "$($env:UserProfile)\Desktop\msdturlprotocol.reg"
            reg import $ImportLocation
        }        
        else 
        {
            reg import $ImportLocation
        }
        } 
    }
catch { 
    Write-Host "Error running the script" -ForegroundColor Red 
}
